<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Edit Document</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body>
<div class="container mt-5">
    <h1 th:text="'Editing: ' + ${document.docName}"></h1>
    <div class="mb-3">
        <label for="content" class="form-label">Content</label>
        <textarea class="form-control" id="content" rows="10" th:text="${document.content}"></textarea>
    </div>
    <div class="mb-3">
        <label class="form-label">Current Editors:</label>
        <ul id="editors" class="list-group"></ul>
    </div>
    <a th:href="@{/dashboard/{userId}(userId=${userId})}" class="btn btn-secondary">Back to Dashboard</a>
    <form th:action="@{/document/{id}/delete(id=${document.id})}" method="post" class="mt-3 d-inline">
        <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure?')">Delete</button>
    </form>
</div>

<script th:inline="javascript">
    var stompClient = null;
    var docId = /*[[${document.id}]]*/ 0;
    var userId = /*[[${userId}]]*/ 0;

    function connect() {
        var socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame);
            stompClient.subscribe('/topic/document/' + docId, function (message) {
                var content = message.body;
                document.getElementById('content').value = content;
            });
            stompClient.subscribe('/topic/editors/' + docId, function (message) {
                var editors = JSON.parse(message.body);
                var editorList = document.getElementById('editors');
                editorList.innerHTML = '';
                editors.forEach(function(editor) {
                    var li = document.createElement('li');
                    li.textContent = editor;
                    editorList.appendChild(li);
                });
            });
            // Send join message
            stompClient.send("/app/join/" + docId, {}, userId.toString());
        });
    }

    function sendContent() {
        var content = document.getElementById('content').value;
        var message = {
            content: content,
            userId: userId
        };
        stompClient.send("/app/document/" + docId, {}, JSON.stringify(message));
    }

    window.onload = function() {
        connect();
        document.getElementById('content').addEventListener('input', function() {
            // Debounce: send after 500ms of no input
            clearTimeout(window.sendTimeout);
            window.sendTimeout = setTimeout(sendContent, 500);
        });
    };
</script>
</body>
</html>